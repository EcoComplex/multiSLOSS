---
title: "Running simulations of MultipleContactNeutralMigrat.nlogo"
author: "Leonardo A. Saravia"
date: "8/11/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE,echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)

needed_packages <- c(
    "tidyverse"
  , "lubridate"
  , "future"
  , "tictoc"
  , "nlrx")

lapply(needed_packages, function(x) { if(!require(x,character.only = TRUE)) install.packages(x)} )

theme_set(theme_bw())
source("R/functions.r")

#
# Where the NetLogo model is
# Setup for nlrx 
#
if( Sys.info()['nodename'] =="ls-pro") {
  simfolder <- "/home/leonardo/Dropbox/Projects/DynamicForestExtinction"
  
} else if(Sys.info()['nodename'] =="biologia2018") {                     # Server UNGS
  simfolder <- "/home/leonardo/Dropbox/Projects/DynamicForestExtinction"                       

} else if(Sys.info()['nodename'] =="MacLeonardo.local") {                     # Mac
  simfolder <- "~/Dropbox/Projects/DynamicForestExtinction"
}

# Unix default NetLogo installation path (adjust to your needs!):
#
netlogopath <- file.path("/home/leonardo/NetLogo")
modelpath <- file.path(simfolder, "MultipleContactNeutralMigrat.nlogo")
outpath <- file.path("Simulations")

# If not defined set the JAVA version of your local 
if(Sys.getenv("JAVA_HOME")==""){
  Sys.setenv(JAVA_HOME = "/usr/lib/jvm/java-11-openjdk-amd64")
  ## "/usr/lib/jvm/java-8-oracle"
}

nl <- nl(nlversion = "6.3",
         nlpath = netlogopath,
         modelpath = modelpath,
         jvmmem = 2048)


```

## Why do several small patches hold more species that few large patches?

## Lambda = 1-4 NoSelection = Neutral  Regular

* Initial conditions: migration from the regional community and after the area is filled of individuals, then 60% of the area degraded with regular patches (t= 200 for lambda=4 ) 
* Check simulations with Migration0-at-deforestation true or false to take into account that immigration happens at the borders and different kinds of deforestation patterns have different border size e.g. regular > randon block 

```{r SLOSS_lambda14_sims_regular,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

# pf = probability of fragmentation, hps = habitat patch size , dd=dispersal distance 
# hps = habitat patch size
# dd = dispersal distance 
# brb = bird rate birds 
nl@experiment <- experiment(expname="NoSelection_pf06_hps3-61_dd1-3_brb1-4_regular",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="false",
                            idsetup="setup",
                            idgo="go",
                            runtime=0,
                            metrics=c("birds-at-deforestation", "calc-number-of-species","calc-shannon-diversity","count birds", "mean-free-path","find-cluster-sizes"),
                            variables = list("birds-dispersal-distance" = list(values=c(1.1, 1.2, 1.5, 2, 3)),
                                              "habitat-patch-size" = list(values=c(3, 9, 29, 61)),
                                               "birth-rate-birds" = list(values=c(1.7, 2, 3, 4))
                                             ),
                            constants = list("world-width" = 199,
                                             "world-height" = 199,
                                             "initial-population" = 0,
                                             "max-birds-species" = 100,
                                             "death-rate-birds" = 1,
                                             "migration-rate-birds" = 0.0001,
                                             "Video" = "false",
                                             "prob-frag" =  0.6,
                                             "Deforestation-at-time" = 200,
                                             "end-time" = 1500,
                                             "Migration0-at-deforestation" = "false",
                                             "deforestation-type" = "\"regular\"",
                                             "birds-behavior" = "\"NoSelection\"",
                                             "replacement-rate" = 0.0
                                             ))


#
# Run nseeds=10 times 
#
# Total number of jobs = nseeds * split = 20*2 
# Each job runs parameter input matrix / split = nrow(nl@simdesign@siminput) / split =  80 / 2 
#

nl@simdesign <- simdesign_ff(nl=nl,
                               nseeds=30)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 2)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)
```

## Read Simulations

```{r readSimulations, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}
# Read previous simulations
#
if( file.exists("Simulations/sloss_sim_ff.rds")) {

  sloss_sim <- readRDS("Simulations/sloss_sim_ff.rds") 
  
} else {
  sloss_sim <- tibble()
}

# Read netlogo simulations and 
# Convert the list of mean_free_path to degraded_mfp and non_degraded_mfp
# Calculate cluster stats
#
# Old 10 - 20 simulations 
# mdl <- read_netlogo_simul(file.path(outpath,"NoSelection_pf06_hps3-61_dd1-3_brb1-4_ff.csv"),skip=0) %>% 
# mdl <- read_netlogo_simul(file.path(outpath,"NoSelection_pf06_hps3-61_dd1-3_brb1-4_20_ff.csv"),skip=0) %>% 

mdl <- read_sloss_simul(outpath,"NoSelection_pf06_hps3-61_dd1-3_brb1-4_regular_ff.csv")

sloss_sim <- bind_rows(sloss_sim,mdl)

saveRDS(sloss_sim, "Simulations/sloss_sim_ff.rds")

netlogo_evaluate_patch_distr(mdl$find_cluster_sizes[1])

```


## Plots - No selection - regular pattern

```{r PlotsNoSelectionRegular, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}
# read data
#
sloss_sim <- readRDS("Simulations/sloss_sim_ff.rds") 

# Neutral communities 
#
mdl <- sloss_sim %>% filter(deforestation_type == "regular",birds_behavior=="NoSelection", habitat_patch_size != 199)
names(mdl)
#
# Plot for neutral communities
# Calculate the power exponent 
# pexp = (1 - 2 * birds_dispersal_distance ) / (1 - birds_dispersal_distance ), median_dispersal_distance = 2^(1/pexp-1) 
#
mdl1 <- mdl %>% mutate(habitat_patch_size = habitat_patch_size+1) %>%
                         group_by(birds_dispersal_distance, habitat_patch_size,birth_rate_birds) %>% summarise(across(c(birds_at_deforestation:count_birds,max_patch,degraded_mfp,non_degraded_mfp),list(mean=mean, sd=sd, ql=~quantile(.x,probs=c((1-0.95)/2)), qh=~quantile(.x,probs=c(1-(1-0.95)/2)) ))) 

names(mdl1)

mdl1 <- mdl1 %>%  mutate(across(max_patch_mean:max_patch_qh,sqrt)) 

#
# Block patch size vs max patch size
#
mdl1 %>%  
  ggplot(aes(x = max_patch_mean, y = habitat_patch_size, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+

mdl1 %>%  
  ggplot(aes(x = max_patch_mean, y = degraded_mfp_mean, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+

mdl1 %>%  
  ggplot(aes(x = max_patch_mean, y = non_degraded_mfp_mean, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+

mdl1 %>%  
  ggplot(aes(x = degraded_mfp_mean, y = non_degraded_mfp_mean, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+



# require(plotly)
# plot_ly(data=mdl1, x=~birds_dispersal_distance, y=~habitat_patch_size, z=~calc_number_of_species, type="scatter3d", mode="markers", color=~calc_number_of_species, marker = list(size = 1))


mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/Species_Habitat_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)
  

# Shannon-Diversity  
#
mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Shannon Diversity") +
  theme(
    legend.position = c(0.9,0.2)
    ) 

ggsave("Figures/Shannon_Habitat_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)


#
# Number of species by max_patch size 
# 
mdl1  %>% #filter(birds_dispersal_distance %in% c(1.1,1.5,3)) %>%
  ggplot(aes(x = max_patch_mean, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Max patch size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/Species_MaxPatch_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)


#
# shannon_diversity by max_patch size 
# 
mdl1  %>% #filter(birds_dispersal_distance %in% c(1.1,1.5,3)) %>%
  ggplot(aes(x = max_patch_mean, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)) ,  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Max patch size") + ylab("Shannon Diversity") +
  theme(
    legend.position = c(0.9,0.2)
    ) 

ggsave("Figures/Shannon_MaxPatch_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)


```


## Lambda = 1-4 / Random Block patterns

* Initial conditions: migration from the regional community and after the area is filled of individuals, then 60% of the area degraded with regular patches (t= 200 for lambda=4 ) 

```{r SLOSS_lambda14_simulations_block,echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

# pf = probability of fragmentation, hps = habitat patch size , dd=dispersal distance 
# hps = habitat patch size
# dd = dispersal distance 
# brb = bird rate birds 
nl@experiment <- experiment(expname="NoSelection_pf06_hps3-61_dd1-3_brb1-4_block",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="false",
                            idsetup="setup",
                            idgo="go",
                            runtime=0,
                            metrics=c("birds-at-deforestation", "calc-number-of-species","calc-shannon-diversity","count birds", "mean-free-path", "find-cluster-sizes"),
                            variables = list("birds-dispersal-distance" = list(values=c(1.1, 1.2, 1.5, 2, 3)),
                                              "habitat-patch-size" = list(values=c(3, 9, 29, 61)),
                                               "birth-rate-birds" = list(values=c(1.7, 2, 3, 4))
                                             ),
                            constants = list("world-width" = 199,
                                             "world-height" = 199,
                                             "initial-population" = 0,
                                             "max-birds-species" = 100,
                                             "death-rate-birds" = 1,
                                             "migration-rate-birds" = 0.0001,
                                             "Video" = "false",
                                             "prob-frag" =  0.6,
                                             "Deforestation-at-time" = 200,
                                             "end-time" = 1500,
                                             "Migration0-at-deforestation" = "false",
                                             "deforestation-type" = "\"random block\"",
                                             "birds-behavior" = "\"NoSelection\"",
                                             "replacement-rate" = 0.0
                                             ))


#
# Run nseeds=10 times 
#
# Total number of jobs = nseeds * split = 30*2 
# Each job runs parameter input matrix / split = nrow(nl@simdesign@siminput) / split =  80 / 2 
#

nl@simdesign <- simdesign_ff(nl=nl,
                               nseeds=30)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 2)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)
```



## Read Simulations No Selection Random Block Patterns

```{r readSimulationsBlock, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}
# Read previous simulations
#
if( file.exists("Simulations/sloss_sim_ff.rds")) {

  sloss_sim <- readRDS("Simulations/sloss_sim_ff.rds") 
  
} else {
  sloss_sim <- tibble()
}

# Read netlogo simulations and 
# Convert the list of mean_free_path to degraded_mfp and non_degraded_mfp
#
mdl <- read_sloss_simul(outpath,"NoSelection_pf06_hps3-61_dd1-3_brb1-4_block_ff.csv")

sloss_sim <- bind_rows(sloss_sim,mdl)


saveRDS(sloss_sim, "Simulations/sloss_sim_ff.rds")

```


## Plots Neutral No Selection Random Block Patterns Plots

```{r NeutralRandomBlockPlots, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

# Neutral communities 
#
mdl <- sloss_sim %>% filter(deforestation_type == "random block", birds_behavior == "NoSelection")
names(mdl)
#
# Plot for neutral communities 
#
mdl1 <- mdl %>% mutate(habitat_patch_size = habitat_patch_size+1) %>%
                         group_by(birds_dispersal_distance, habitat_patch_size,birth_rate_birds) %>% summarise(across(c(birds_at_deforestation:count_birds,non_degraded_mfp,degraded_mfp,max_patch) ,list(mean=mean, sd=sd, ql=~quantile(.x,probs=c((1-0.95)/2)), qh=~quantile(.x,probs=c(1-(1-0.95)/2)) ))) #  %>% mutate(deltaPop = (count_birds - birds_at_deforestation )/ 

names(mdl1)
mdl1 <- mdl1 %>%  mutate(across(max_patch_mean:max_patch_qh,sqrt)) 

#
# Block patch size vs max patch size
#
mdl1 %>%  
  ggplot(aes(x = max_patch_mean, y = habitat_patch_size, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+

mdl1 %>%  
  ggplot(aes(x = max_patch_mean, y = degraded_mfp_mean, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+

mdl1 %>%  
  ggplot(aes(x = max_patch_mean, y = non_degraded_mfp_mean, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+

mdl1 %>%  
  ggplot(aes(x = degraded_mfp_mean, y = non_degraded_mfp_mean, color = factor(habitat_patch_size))) + 
  geom_point(  size = 1.2) + guides(color = "none") #+

#
# Number of species by patch block size
#
mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/Species_Habitat_Dispersal_Lambda_block.png",width=8,height=6,units="in",dpi=600)
  



# Shannon-Diversity  
#
mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 


ggsave("Figures/Shannon_Habitat_Dispersal_Lambda_block.png",width=8,height=6,units="in",dpi=600)


#
# Number of species by max_patch size 
# 
mdl1  %>% #filter(birds_dispersal_distance %in% c(1.1,1.5,3)) %>%
  ggplot(aes(x = max_patch_mean, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Max patch size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.83)
    ) 

ggsave("Figures/Species_MaxPatch_Dispersal_Lambda_block.png",width=8,height=6,units="in",dpi=600)


#
# shannon_diversity by max_patch size 
# 
mdl1  %>% # filter(birds_dispersal_distance %in% c(1.1,1.5,3)) %>%
  ggplot(aes(x = max_patch_mean, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.2,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Max patch size") + ylab("Shannon Diversity") +
  theme(
    legend.position = c(0.9,0.2)
    ) 

ggsave("Figures/Shannon_MaxPatch_Dispersal_Lambda_block.png",width=8,height=6,units="in",dpi=600)


```


## Simulations Lambda = 1-4 / Regular patterns - Hierarchical communities 

* Initial conditions: migration from the regional community and after the area is filled of individuals, then 60% of the area degraded with regular patches (t= 200 for lambda=4 ) 

```{r Hierarchical_SLOSS_lambda14_simulations_regular,echo=FALSE,message=FALSE,warning=FALSE,eval=FALSE}

# pf = probability of fragmentation, hps = habitat patch size , dd=dispersal distance 
# hps = habitat patch size
# dd = dispersal distance 
# brb = bird rate birds 
nl@experiment <- experiment(expname="Hierarchical_pf06_hps3-61_dd1-3_brb1-4_regular",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="false",
                            idsetup="setup",
                            idgo="go",
                            runtime=0,
                            metrics=c("birds-at-deforestation", "calc-number-of-species","calc-shannon-diversity","count birds", "mean-free-path","find-cluster-sizes"),
                            variables = list("birds-dispersal-distance" = list(values=c(1.1, 1.2, 1.5, 2, 3)),
                                              "habitat-patch-size" = list(values=c(3, 9, 29, 61)),
                                               "birth-rate-birds" = list(values=c(1.7, 2, 3, 4))
                                             ),
                            constants = list("world-width" = 199,
                                             "world-height" = 199,
                                             "initial-population" = 0,
                                             "max-birds-species" = 100,
                                             "death-rate-birds" = 1,
                                             "migration-rate-birds" = 0.0001,
                                             "Video" = "false",
                                             "prob-frag" =  0.6,
                                             "Deforestation-at-time" = 200,
                                             "end-time" = 1500,
                                             "Migration0-at-deforestation" = "false",
                                             "deforestation-type" = "\"regular\"",
                                             "birds-behavior" = "\"Hierarchical\"",
                                             "replacement-rate" = 0.3
                                             ))


#
# Run nseeds=10 times 
#
# Total number of jobs = nseeds * split = 30*2 
# Each job runs parameter input matrix / split = nrow(nl@simdesign@siminput) / split =  80 / 2 
#

nl@simdesign <- simdesign_ff(nl=nl,
                               nseeds=30)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 2)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)
```
  
## Read Simulations hierarchical regular Patterns

```{r readSimulationsHierarchicalRegular, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}
# Read previous simulations
#
if( file.exists("Simulations/sloss_sim_ff.rds")) {

  sloss_sim <- readRDS("Simulations/sloss_sim_ff.rds") 
  
} else {
  sloss_sim <- tibble()
}

# Read netlogo simulations and 
# Convert the list of mean_free_path to degraded_mfp and non_degraded_mfp
#
mdl <- read_sloss_simul(outpath,"Hierarchical_pf06_hps3-61_dd1-3_brb1-4_regular_ff.csv")

sloss_sim <- bind_rows(sloss_sim,mdl)

saveRDS(sloss_sim, "Simulations/sloss_sim_ff.rds")

```


# Plot for hierarchical communities 

```{r ExploratoryPlotsHierarchical, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

mdl <- sloss_sim %>% filter(deforestation_type == "regular", birds_behavior=="Hierarchical", habitat_patch_size != 199)
names(mdl)
#
# summarize data 
#
mdl1 <- mdl %>% mutate(habitat_patch_size = habitat_patch_size+1) %>%
                         group_by(birds_dispersal_distance, habitat_patch_size,birth_rate_birds) %>% summarise(across(birds_at_deforestation:count_birds,list(mean=mean, sd=sd, ql=~quantile(.x,probs=c((1-0.95)/2)), qh=~quantile(.x,probs=c(1-(1-0.95)/2)) ))) #  %>% mutate(deltaPop = (count_birds - birds_at_deforestation )/ birds_at_deforestation  )
names(mdl1)

# require(plotly)
# plot_ly(data=mdl1, x=~birds_dispersal_distance, y=~habitat_patch_size, z=~calc_number_of_species, type="scatter3d", mode="markers", color=~calc_number_of_species, marker = list(size = 1))

mdl1 %>% 
  ggplot(aes(x=habitat_patch_size, y=calc_number_of_species_mean, color=birds_dispersal_distance)) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds))) +
  geom_ribbon(
    aes(
      ymin = calc_number_of_species_ql,
      ymax = calc_number_of_species_qh,
      fill = birds_dispersal_distance
    ),
    alpha = 0.3,
    colour = NA,
    show.legend = FALSE
      
  ) +
  scale_color_viridis_c(guide = FALSE) + 
  scale_fill_viridis_c() +
  facet_grid(birds_dispersal_distance ~ birth_rate_birds) + 
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species")

mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/Hierarchical_Species_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)
  

# Shannon-Diversity  
#
mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 


ggsave("Figures/Hierarchical_Shannon_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)


```


## Simulations Lambda = 1-4 / Regular patterns - Birth Selection communities 

* Initial conditions: migration from the regional community and after the area is filled of individuals, then 60% of the area degraded with regular patches (t= 200 for lambda=4 ) 

```{r Selection_SLOSS_lambda14_simulations_regular,echo=FALSE,message=FALSE,warning=FALSE,eval=FALSE}

# pf = probability of fragmentation, hps = habitat patch size , dd=dispersal distance 
# hps = habitat patch size
# dd = dispersal distance 
# brb = bird rate birds 
nl@experiment <- experiment(expname="Selection_pf06_hps3-61_dd1-3_brb1-4_regular",
                            outpath=outpath,
                            repetition=1,
                            tickmetrics="false",
                            idsetup="setup",
                            idgo="go",
                            runtime=0,
                            metrics=c("birds-at-deforestation", "calc-number-of-species","calc-shannon-diversity","count birds", "mean-free-path","find-cluster-sizes"),
                            variables = list("birds-dispersal-distance" = list(values=c(1.1, 1.2, 1.5, 2, 3)),
                                              "habitat-patch-size" = list(values=c(3, 9, 29, 61)),
                                               "birth-rate-birds" = list(values=c(1.7, 2, 3, 4))
                                             ),
                            constants = list("world-width" = 199,
                                             "world-height" = 199,
                                             "initial-population" = 0,
                                             "max-birds-species" = 100,
                                             "death-rate-birds" = 1,
                                             "migration-rate-birds" = 0.0001,
                                             "Video" = "false",
                                             "prob-frag" =  0.6,
                                             "Deforestation-at-time" = 200,
                                             "end-time" = 1500,
                                             "Migration0-at-deforestation" = "false",
                                             "deforestation-type" = "\"regular\"",
                                             "birds-behavior" = "\"BirthSelection\"",
                                             "replacement-rate" = 0.3
                                             ))


#
# Run nseeds=10 times 
#
# Total number of jobs = nseeds * split = 30*2 
# Each job runs parameter input matrix / split = nrow(nl@simdesign@siminput) / split =  80 / 2 
#

nl@simdesign <- simdesign_ff(nl=nl,
                               nseeds=30)

# run in Paralell 
#
plan(multisession)
tic()
results <- run_nl_all(nl,split = 2)
#results <- run_nl_all(nl,split = 4)
toc()
plan(sequential)
names(results)

#
# Write the output 
#
setsim(nl, "simoutput") <- results 
write_simoutput(nl)
```
  
## Read Simulations Birth Selection  regular Patterns

```{r readSimulationsSelectionRegular, echo=FALSE,message=FALSE,warning=FALSE,eval=FALSE}
# Read previous simulations
#
if( file.exists("Simulations/sloss_sim_ff.rds")) {

  sloss_sim <- readRDS("Simulations/sloss_sim_ff.rds") 
  
} else {
  sloss_sim <- tibble()
}

# Read netlogo simulations and 
# Convert the list of mean_free_path to degraded_mfp and non_degraded_mfp
#
mdl <- read_sloss_simul(outpath,"Selection_pf06_hps3-61_dd1-3_brb1-4_regular_ff.csv")

sloss_sim <- bind_rows(sloss_sim,mdl)

saveRDS(sloss_sim, "Simulations/sloss_sim_ff.rds")

```

# Plot for birth selection communities regular patterns 

```{r ExploratoryPlotsSelectionRegular, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

mdl <- sloss_sim %>% filter(deforestation_type == "regular", birds_behavior=="BirthSelection", habitat_patch_size != 199)
names(mdl)
#
# summarize data 
#
mdl1 <- mdl %>% mutate(habitat_patch_size = habitat_patch_size+1) %>%
                         group_by(birds_dispersal_distance, habitat_patch_size,birth_rate_birds) %>% summarise(across(birds_at_deforestation:count_birds,list(mean=mean, sd=sd, ql=~quantile(.x,probs=c((1-0.95)/2)), qh=~quantile(.x,probs=c(1-(1-0.95)/2)) ))) #  %>% mutate(deltaPop = (count_birds - birds_at_deforestation )/ birds_at_deforestation  )
names(mdl1)

# require(plotly)
# plot_ly(data=mdl1, x=~birds_dispersal_distance, y=~habitat_patch_size, z=~calc_number_of_species, type="scatter3d", mode="markers", color=~calc_number_of_species, marker = list(size = 1))

mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/Selection_Species_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)
  

# Shannon-Diversity  
#
mdl1 %>%  
  ggplot(aes(x = habitat_patch_size, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, birth_rate_birds), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birth_rate_birds, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Shannon Diversity") +
  theme(
    legend.position = c(0.9,0.8)
    ) 


ggsave("Figures/Selection_Shannon_Dispersal_Lambda_regular.png",width=8,height=6,units="in",dpi=600)


```


## Plots across neutral hierarchical selection modelos regular fragmentation

```{r PlotsAcrossBehaviorRegular, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

mdl <- sloss_sim %>% filter(deforestation_type == "regular", habitat_patch_size != 199)
names(mdl)
#
# summarize data 
#
mdl1 <- mdl %>% mutate(habitat_patch_size = habitat_patch_size+1) %>%
                         group_by(birds_dispersal_distance, habitat_patch_size,birth_rate_birds,birds_behavior) %>% summarise(across(birds_at_deforestation:count_birds,list(mean=mean, sd=sd, ql=~quantile(.x,probs=c((1-0.95)/2)), qh=~quantile(.x,probs=c(1-(1-0.95)/2)) ))) #  %>% mutate(deltaPop = (count_birds - birds_at_deforestation )/ birds_at_deforestation  )
names(mdl1)

mdl1 %>%  filter(birth_rate_birds == 2) %>% 
  ggplot(aes(x = habitat_patch_size, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, birds_behavior), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birds_behavior, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/AcrossBehav_Species_Dispersal_Lambda2_regular.png",width=8,height=6,units="in",dpi=600)
  

# Shannon-Diversity  
#
mdl1 %>%  filter(birth_rate_birds == 2) %>% 
  ggplot(aes(x = habitat_patch_size, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, birds_behavior), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ birds_behavior, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Habitat Patch Size") + ylab("Shannon Diversity") +
  theme(
    legend.position = c(0.9,0.8)
    ) 


ggsave("Figures/AcrossBehav_Shannon_Dispersal_Lambda2_regular.png",width=8,height=6,units="in",dpi=600)


```




## Plots across neutral hierarchical selection modelos regular fragmentation

```{r PlotsAcrossBehaviorRegular, echo=FALSE,message=FALSE,warning=FALSE,fig.align='center',eval=FALSE}

mdl <- sloss_sim %>% filter(birds_behavior=="NoSelection", habitat_patch_size != 199)
names(mdl)
#
# summarize data 
#
mdl1 <- mdl %>% mutate(habitat_patch_size = habitat_patch_size+1) %>%
                         group_by(birds_dispersal_distance, habitat_patch_size,birth_rate_birds,deforestation_type) %>% summarise(across(c(birds_at_deforestation:count_birds,max_patch,degraded_mfp,non_degraded_mfp),list(mean=mean, sd=sd, ql=~quantile(.x,probs=c((1-0.95)/2)), qh=~quantile(.x,probs=c(1-(1-0.95)/2)) ))) #  %>% mutate(deltaPop = (count_birds - birds_at_deforestation )/ birds_at_deforestation  )
names(mdl1)

mdl1 <- mdl1 %>%  mutate(across(max_patch_mean:max_patch_qh,sqrt)) 


mdl1 %>%  filter(birth_rate_birds == 2) %>% 
  ggplot(aes(x = max_patch_mean, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, deforestation_type), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ deforestation_type, ncol = 2) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Max Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/AcrossLoss_Species_Dispersal_Lambda2.png",width=8,height=6,units="in",dpi=600)
  

# Shannon-Diversity  
#

mdl1 %>%  filter(birth_rate_birds == 2) %>% 
  ggplot(aes(x = max_patch_mean, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, deforestation_type), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ deforestation_type, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Max Habitat Patch Size") + ylab("Shannon Diversity") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/AcrossLoss_Shannon_Dispersal_Lambda2.png",width=8,height=6,units="in",dpi=600)



#
# summarize data mean patch size
#
mdl1 <- mdl %>% mutate(habitat_patch_size = habitat_patch_size+1) %>%
                         group_by(birds_dispersal_distance, habitat_patch_size,birth_rate_birds,deforestation_type) %>% summarise(across(c(birds_at_deforestation:count_birds,mean_patch,degraded_mfp,non_degraded_mfp),list(mean=mean, sd=sd, ql=~quantile(.x,probs=c((1-0.95)/2)), qh=~quantile(.x,probs=c(1-(1-0.95)/2)) ))) #  %>% mutate(deltaPop = (count_birds - birds_at_deforestation )/ birds_at_deforestation  )
names(mdl1)

mdl1 <- mdl1 %>%  mutate(across(mean_patch_mean:mean_patch_qh,sqrt)) 


mdl1 %>%  filter(birth_rate_birds == 2) %>% 
  ggplot(aes(x = mean_patch_mean, y = calc_number_of_species_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_number_of_species_ql, ymax = calc_number_of_species_qh, group = interaction(birds_dispersal_distance, deforestation_type), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ deforestation_type, ncol = 2) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Mean Habitat Patch Size") + ylab("Number of species") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/AcrossLoss_Species_Dispersal_Lambda2_mean.png",width=8,height=6,units="in",dpi=600)
  

# Shannon-Diversity  
#

mdl1 %>%  filter(birth_rate_birds == 2) %>% 
  ggplot(aes(x = mean_patch_mean, y = calc_shannon_diversity_mean, color = factor(birds_dispersal_distance))) + 
  geom_line(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = .5) +
  geom_point(aes(group = interaction(birds_dispersal_distance, birth_rate_birds)),  size = 1.2) +
  geom_ribbon(aes(ymin = calc_shannon_diversity_ql, ymax = calc_shannon_diversity_qh, group = interaction(birds_dispersal_distance, deforestation_type), fill = factor(birds_dispersal_distance)), alpha = 0.3,colour=NA, show.legend = FALSE) +
  scale_color_viridis_d() + scale_fill_viridis_d() +
  facet_wrap(~ deforestation_type, ncol = 4) + 
  labs(color = "Dispersal\n distance") +
  theme_bw() + xlab("Mean Habitat Patch Size") + ylab("Shannon Diversity") +
  theme(
    legend.position = c(0.9,0.8)
    ) 

ggsave("Figures/AcrossLoss_Shannon_Dispersal_Lambda2_mean.png",width=8,height=6,units="in",dpi=600)

```

